'use client';

import { useEffect, useRef, useState, useCallback } from 'react';
import mapboxgl from 'mapbox-gl';
import { MapData, SpotData, spotTypes } from '@/hooks/useFirestore';
import GooglePlacesSearch from './GooglePlacesSearch';
import SpotEditor from './SpotEditor';
import SpotList from './SpotList';
import Link from 'next/link';
import 'mapbox-gl/dist/mapbox-gl.css';

interface MapEditorProps {
  map: MapData;
  onUpdateMap: (mapData: Partial<MapData>) => Promise<void>;
  onAddSpot: (spotData: Omit<SpotData, 'id' | 'createdAt'>) => Promise<SpotData>;
  onUpdateSpot: (spotId: string, spotData: Partial<SpotData>) => Promise<void>;
  onDeleteSpot: (spotId: string) => Promise<void>;
}

export default function MapEditor({
  map,
  onUpdateMap,
  onAddSpot,
  onUpdateSpot,
  onDeleteSpot
}: MapEditorProps) {
  const mapContainer = useRef<HTMLDivElement>(null);
  const mapRef = useRef<mapboxgl.Map | null>(null);
  const markersRef = useRef<{ [key: string]: mapboxgl.Marker }>({});
  const [mapInitialized, setMapInitialized] = useState(false);
  
  const [loading, setLoading] = useState(true);
  const [editingSpot, setEditingSpot] = useState<SpotData | null>(null);
  const [showSpotEditor, setShowSpotEditor] = useState(false);
  const [clickCoordinates, setClickCoordinates] = useState<{ lat: number; lng: number } | null>(null);
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const [mapError, setMapError] = useState<string | null>(null);
  
  // åœ°å›³è¨­å®šã®ç·¨é›†çŠ¶æ…‹
  const [showMapSettings, setShowMapSettings] = useState(false);
  const [mapTitle, setMapTitle] = useState(map.title);
  const [mapDescription, setMapDescription] = useState(map.description);
  const [mapIsPublic, setMapIsPublic] = useState(map.isPublic);
  const [saveLoading, setSaveLoading] = useState(false);

  // åœ°å›³ã®åˆæœŸåŒ–ï¼ˆ1å›ã®ã¿ã€ä¾å­˜é…åˆ—ãªã—ï¼‰
  useEffect(() => {
    if (!mapContainer.current || mapInitialized) {
      return;
    }

    const accessToken = process.env.NEXT_PUBLIC_MAPBOX_ACCESS_TOKEN;
    if (!accessToken) {
      setMapError('Mapboxã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      setLoading(false);
      return;
    }

    console.log('ğŸ—ºï¸ Initializing Mapbox (ONE TIME ONLY)');
    mapboxgl.accessToken = accessToken;

    const spots = map.spots || [];
    const center = spots.length > 0 
      ? [spots[0].coordinates.lng, spots[0].coordinates.lat] as [number, number]
      : [139.6917, 35.6895] as [number, number];

    try {
      setMapInitialized(true);
      
      mapRef.current = new mapboxgl.Map({
        container: mapContainer.current,
        style: 'mapbox://styles/mapbox/streets-v12',
        center,
        zoom: spots.length > 0 ? 12 : 10,
        antialias: true
      });

      // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’è¿½åŠ 
      mapRef.current.addControl(new mapboxgl.NavigationControl(), 'bottom-right');
      mapRef.current.addControl(
        new mapboxgl.GeolocateControl({
          positionOptions: {
            enableHighAccuracy: true
          },
          trackUserLocation: true,
          showUserHeading: true
        }),
        'bottom-right'
      );

      // åœ°å›³ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
      mapRef.current.on('click', (e) => {
        const { lng, lat } = e.lngLat;
        console.log('ğŸ¯ Map clicked at:', { lat, lng });
        setClickCoordinates({ lat, lng });
        setEditingSpot(null);
        setShowSpotEditor(true);
      });

      // åœ°å›³èª­ã¿è¾¼ã¿å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆ
      mapRef.current.on('load', () => {
        console.log('âœ… Mapbox map loaded successfully (ONE TIME)');
        setLoading(false);
        setMapError(null);
        updateMarkers();
      });

      // ã‚¨ãƒ©ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ
      mapRef.current.on('error', (e) => {
        console.error('âŒ Mapbox error:', e);
        setMapError('åœ°å›³ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        setLoading(false);
      });

    } catch (error: any) {
      console.error('âŒ Error creating Mapbox map:', error);
      setMapError('åœ°å›³ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      setLoading(false);
      setMapInitialized(false);
    }

    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—é–¢æ•°
    return () => {
      if (mapRef.current) {
        console.log('ğŸ§¹ Cleaning up Mapbox map');
        mapRef.current.remove();
        mapRef.current = null;
      }
      setMapInitialized(false);
    };
  }, []); // ç©ºã®ä¾å­˜é…åˆ—ã§1å›ã®ã¿å®Ÿè¡Œ

  // ãƒãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚ŒãŸæ™‚ã«çŠ¶æ…‹ã‚’åŒæœŸ
  useEffect(() => {
    setMapTitle(map.title);
    setMapDescription(map.description);
    setMapIsPublic(map.isPublic);
  }, [map.title, map.description, map.isPublic]);

  // ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°ï¼ˆã‚¹ãƒãƒƒãƒˆå¤‰æ›´æ™‚ã®ã¿ï¼‰
  const updateMarkers = useCallback(() => {
    if (!mapRef.current || !mapRef.current.isStyleLoaded()) {
      console.log('â³ Map not ready for markers, retrying...');
      setTimeout(updateMarkers, 100);
      return;
    }

    console.log('ğŸ”„ Updating markers (NO MAP RELOAD). Total spots:', map.spots?.length || 0);

    const currentSpots = map.spots || [];
    
    // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã™ã¹ã¦å‰Šé™¤
    Object.values(markersRef.current).forEach(marker => {
      marker.remove();
    });
    markersRef.current = {};

    // æ–°ã—ã„ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ ï¼ˆç•ªå·ä»˜ãï¼‰
    currentSpots.forEach((spot, index) => {
      if (!spot.id) {
        console.log('âš ï¸ Spot without ID found:', spot);
        return;
      }

      const spotNumber = index + 1;
      console.log(`ğŸ“ Adding marker ${spotNumber} for spot: ${spot.name}`);

      const markerElement = document.createElement('div');
      markerElement.className = 'custom-marker';
      markerElement.innerHTML = `
        <div style="
          background: #3B82F6;
          border: 3px solid white;
          border-radius: 50%;
          width: 32px;
          height: 32px;
          cursor: pointer;
          box-shadow: 0 2px 4px rgba(0,0,0,0.3);
          display: flex;
          align-items: center;
          justify-content: center;
          color: white;
          font-weight: bold;
          font-size: 14px;
          font-family: system-ui, -apple-system, sans-serif;
          transition: transform 0.2s;
        " 
        onmouseover="this.style.transform='scale(1.1)'" 
        onmouseout="this.style.transform='scale(1)'"
        >${spotNumber}</div>
      `;

      try {
        const marker = new mapboxgl.Marker(markerElement)
          .setLngLat([spot.coordinates.lng, spot.coordinates.lat])
          .setPopup(
            new mapboxgl.Popup({ offset: 25 }).setHTML(`
              <div class="p-3">
                <div class="flex items-center mb-2">
                  <span class="inline-flex items-center justify-center w-6 h-6 bg-blue-600 text-white rounded-full text-sm font-bold mr-2">
                    ${spotNumber}
                  </span>
                  <h3 class="font-bold text-lg">${spot.name}</h3>
                </div>
                ${spot.description ? `<p class="text-sm text-gray-600 mb-2">${spot.description}</p>` : ''}
                ${spot.address ? `<p class="text-xs text-gray-500 mb-2">${spot.address}</p>` : ''}
                ${spot.rating ? `<div class="text-sm">è©•ä¾¡: ${spot.rating}/5</div>` : ''}
              </div>
            `)
          )
          .addTo(mapRef.current!);

        markerElement.addEventListener('click', (e) => {
          e.stopPropagation();
          setEditingSpot(spot);
          setClickCoordinates(null);
          setShowSpotEditor(true);
        });

        markersRef.current[spot.id] = marker;
      } catch (error) {
        console.error('âŒ Error adding marker:', error);
      }
    });

    console.log('âœ… Markers updated (NO MAP RELOAD). Total markers:', Object.keys(markersRef.current).length);
  }, [map.spots]);

  // ã‚¹ãƒãƒƒãƒˆãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã®ã¿ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
  useEffect(() => {
    if (mapRef.current && mapRef.current.isStyleLoaded()) {
      updateMarkers();
    }
  }, [map.spots, updateMarkers]);

  const handleSaveMapSettings = async () => {
    setSaveLoading(true);
    try {
      await onUpdateMap({
        title: mapTitle,
        description: mapDescription,
        isPublic: mapIsPublic
      });
      
      setShowMapSettings(false);
      
      if (mapIsPublic) {
        alert('åœ°å›³è¨­å®šã‚’ä¿å­˜ã—ã€ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã«å…¬é–‹ã—ã¾ã—ãŸï¼');
      } else {
        alert('åœ°å›³è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆéå…¬é–‹ï¼‰');
      }
    } catch (error) {
      console.error('åœ°å›³è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setSaveLoading(false);
    }
  };

  // Google Placesæ¤œç´¢ã§å ´æ‰€ãŒé¸æŠã•ã‚ŒãŸæ™‚ã®å‡¦ç†ï¼ˆåœ°å›³å†èª­ã¿è¾¼ã¿ãªã—ï¼‰
  const handlePlaceSelect = useCallback(async (place: google.maps.places.PlaceResult) => {
    console.log('ğŸ¯ MapEditor - Place selected (NO MAP RELOAD):', place?.name);
    
    if (!place.geometry?.location) {
      console.log('âŒ MapEditor - No geometry in place');
      return;
    }

    const lat = typeof place.geometry.location.lat === 'function' 
      ? place.geometry.location.lat() 
      : place.geometry.location.lat;
    const lng = typeof place.geometry.location.lng === 'function'
      ? place.geometry.location.lng()
      : place.geometry.location.lng;

    console.log('ğŸ“ MapEditor - Coordinates:', { lat, lng });

    const spotData = {
      name: place.name || 'Unknown Place',
      description: '',
      coordinates: { lat, lng },
      type: 'other',
      address: place.formatted_address || ''
    };

    try {
      console.log('ğŸ’¾ MapEditor - Adding spot (NO MAP RELOAD)');
      const newSpot = await onAddSpot(spotData);
      console.log('âœ… MapEditor - Spot added successfully (NO MAP RELOAD):', newSpot);
      
      // åœ°å›³ã‚’æ–°ã—ã„ã‚¹ãƒãƒƒãƒˆã«ç§»å‹•ï¼ˆåœ°å›³ã¯å†èª­ã¿è¾¼ã¿ã—ãªã„ï¼‰
      if (mapRef.current && mapRef.current.isStyleLoaded()) {
        mapRef.current.flyTo({
          center: [lng, lat],
          zoom: 15,
          duration: 1000
        });
      }
    } catch (error) {
      console.error('âŒ MapEditor - ã‚¹ãƒãƒƒãƒˆè¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
      alert('ã‚¹ãƒãƒƒãƒˆã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error as Error).message);
    }
  }, [onAddSpot]);

  // ã‚¹ãƒãƒƒãƒˆä¿å­˜å‡¦ç†
  const handleSaveSpot = async (spotData: Omit<SpotData, 'id' | 'createdAt'>) => {
    try {
      if (editingSpot) {
        console.log('âœï¸ Updating spot:', editingSpot.id);
        await onUpdateSpot(editingSpot.id!, spotData);
      } else {
        console.log('â• Adding new spot from manual input');
        await onAddSpot(spotData);
      }
      setShowSpotEditor(false);
      setEditingSpot(null);
      setClickCoordinates(null);
    } catch (error) {
      console.error('ã‚¹ãƒãƒƒãƒˆä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      alert('ã‚¹ãƒãƒƒãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error as Error).message);
    }
  };

  // ã‚¹ãƒãƒƒãƒˆå‰Šé™¤å‡¦ç†
  const handleDeleteSpot = async (spotId: string) => {
    try {
      console.log('ğŸ—‘ï¸ Deleting spot:', spotId);
      await onDeleteSpot(spotId);
      setShowSpotEditor(false);
      setEditingSpot(null);
    } catch (error) {
      console.error('ã‚¹ãƒãƒƒãƒˆå‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
      alert('ã‚¹ãƒãƒƒãƒˆã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (error as Error).message);
    }
  };

  // ã‚¹ãƒãƒƒãƒˆã‚¯ãƒªãƒƒã‚¯å‡¦ç†
  const handleSpotClick = (spot: SpotData) => {
    if (mapRef.current && mapRef.current.isStyleLoaded()) {
      mapRef.current.flyTo({
        center: [spot.coordinates.lng, spot.coordinates.lat],
        zoom: 16,
        duration: 1000
      });
      
      const marker = markersRef.current[spot.id!];
      if (marker) {
        marker.getPopup().addTo(mapRef.current);
      }
    }
  };

  // åœ°å›³ã®å†èª­ã¿è¾¼ã¿
  const handleRetryMap = () => {
    setMapError(null);
    setLoading(true);
    setMapInitialized(false);
    
    // æ—¢å­˜ã®åœ°å›³ã‚’å‰Šé™¤
    if (mapRef.current) {
      mapRef.current.remove();
      mapRef.current = null;
    }
    
    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰å†åˆæœŸåŒ–
    setTimeout(() => {
      window.location.reload();
    }, 1000);
  };

  return (
    <div className="flex h-screen bg-gray-100">
      {/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã‚µã‚¤ãƒ‰ãƒãƒ¼ */}
      <div className={`bg-white shadow-lg transition-all duration-300 ${
        sidebarOpen ? 'w-80 md:w-80 sm:w-72' : 'w-0'
      } overflow-hidden flex flex-col`}>
        
        {/* ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆå›ºå®šï¼‰ */}
        <div className="flex-shrink-0 p-4 border-b bg-blue-50">
          <div className="flex items-center justify-between mb-2">
            <h2 className="text-lg font-bold text-gray-900 truncate">{map.title}</h2>
            <button
              onClick={() => setShowMapSettings(true)}
              className="text-blue-600 hover:text-blue-700 text-sm"
            >
              è¨­å®š
            </button>
          </div>
          <p className="text-sm text-gray-600 line-clamp-2">{map.description}</p>
          <div className="flex items-center justify-between mt-2 text-xs text-gray-500">
            <span className={map.isPublic ? 'text-green-600 font-medium' : 'text-orange-600 font-medium'}>
              {map.isPublic ? 'âœ… å…¬é–‹ä¸­' : 'ğŸ”’ éå…¬é–‹'}
            </span>
            <span>{map.spots?.length || 0} ã‚¹ãƒãƒƒãƒˆ</span>
          </div>
        </div>
        
        {/* æ¤œç´¢ã‚¨ãƒªã‚¢ï¼ˆå›ºå®šï¼‰ */}
        <div className="flex-shrink-0 p-4 border-b">
          <GooglePlacesSearch
            onPlaceSelect={handlePlaceSelect}
            placeholder="å ´æ‰€ã‚’æ¤œç´¢ã—ã¦ã‚¹ãƒãƒƒãƒˆã‚’è¿½åŠ ..."
            className="w-full"
          />
          <p className="text-xs text-gray-500 mt-2">
            ã¾ãŸã¯åœ°å›³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚¹ãƒãƒƒãƒˆã‚’è¿½åŠ 
          </p>
        </div>
        
        {/* ã‚¹ãƒãƒƒãƒˆãƒªã‚¹ãƒˆï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½ï¼‰ */}
        <div className="flex-1 overflow-y-auto p-4">
          <SpotList
            spots={map.spots || []}
            onEditSpot={(spot) => {
              setEditingSpot(spot);
              setClickCoordinates(null);
              setShowSpotEditor(true);
            }}
            onDeleteSpot={handleDeleteSpot}
            onSpotClick={handleSpotClick}
          />
        </div>
      </div>

      {/* ãƒ¡ã‚¤ãƒ³åœ°å›³ã‚¨ãƒªã‚¢ */}
      <div className="flex-1 relative">
        <div className="absolute top-4 left-4 right-4 z-10 flex justify-between items-center">
          <button
            onClick={() => setSidebarOpen(!sidebarOpen)}
            className="bg-white p-2 rounded-md shadow-md hover:bg-gray-50 transition-colors"
          >
            <span className="text-gray-600">
              {sidebarOpen ? 'â†' : 'â†’'}
            </span>
          </button>

          <div className="flex space-x-2">
            <button
              onClick={() => setShowMapSettings(true)}
              className="bg-white px-3 py-2 rounded-md shadow-md hover:bg-gray-50 transition-colors text-sm hidden sm:block"
            >
              åœ°å›³è¨­å®š
            </button>
            <Link
              href={`/maps/${map.id}`}
              className="bg-blue-600 text-white px-3 py-2 rounded-md shadow-md hover:bg-blue-700 transition-colors text-sm"
            >
              ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            </Link>
          </div>
        </div>

        <div 
          ref={mapContainer} 
          className="w-full h-full"
          style={{ minHeight: '400px' }}
        />
        
        {loading && (
          <div className="absolute inset-0 bg-gray-100 flex items-center justify-center">
            <div className="text-center">
              <div className="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mb-2"></div>
              <div className="text-gray-600">åœ°å›³ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
          </div>
        )}

        {mapError && (
          <div className="absolute inset-0 bg-gray-100 flex items-center justify-center">
            <div className="text-center max-w-md mx-4">
              <div className="text-red-600 mb-4 text-sm">{mapError}</div>
              <div className="space-y-2">
                <button
                  onClick={handleRetryMap}
                  className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors"
                >
                  åœ°å›³ã‚’å†èª­ã¿è¾¼ã¿
                </button>
                <div className="text-xs text-gray-500">
                  å•é¡ŒãŒç¶šãå ´åˆã¯ã€ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„
                </div>
              </div>
            </div>
          </div>
        )}

        {/* åœ°å›³è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« */}
        {showMapSettings && (
          <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20">
            <div className="bg-white rounded-lg p-6 max-w-md w-full mx-4">
              <h3 className="text-lg font-semibold mb-4">åœ°å›³è¨­å®š</h3>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    åœ°å›³ã®ã‚¿ã‚¤ãƒˆãƒ«
                  </label>
                  <input
                    type="text"
                    value={mapTitle}
                    onChange={(e) => setMapTitle(e.target.value)}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 placeholder-gray-500"
                    placeholder="åœ°å›³ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    èª¬æ˜
                  </label>
                  <textarea
                    value={mapDescription}
                    onChange={(e) => setMapDescription(e.target.value)}
                    rows={3}
                    className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-gray-900 placeholder-gray-500"
                    placeholder="ã“ã®åœ°å›³ã«ã¤ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„"
                  />
                </div>

                <div className="border-t pt-4">
                  <label className="flex items-start">
                    <input
                      type="checkbox"
                      checked={mapIsPublic}
                      onChange={(e) => setMapIsPublic(e.target.checked)}
                      className="mr-3 mt-1"
                    />
                    <div>
                      <span className="text-sm font-medium text-gray-700">
                        ã“ã®åœ°å›³ã‚’ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã«å…¬é–‹ã™ã‚‹
                      </span>
                      <p className="text-xs text-gray-500 mt-1">
                        å…¬é–‹ã™ã‚‹ã¨ã€ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã“ã®åœ°å›³ã‚’é–²è¦§ãƒ»ã„ã„ã­ãƒ»è³¼å…¥ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™
                      </p>
                    </div>
                  </label>
                </div>
              </div>

              <div className="flex space-x-2 mt-6">
                <button
                  onClick={() => setShowMapSettings(false)}
                  className="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600 transition-colors"
                >
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button
                  onClick={handleSaveMapSettings}
                  disabled={saveLoading}
                  className="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 disabled:opacity-50 transition-colors"
                >
                  {saveLoading ? 'ä¿å­˜ä¸­...' : (mapIsPublic ? 'å…¬é–‹ã—ã¦ä¿å­˜' : 'ä¿å­˜')}
                </button>
              </div>
            </div>
          </div>
        )}

        {/* ã‚¹ãƒãƒƒãƒˆã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« */}
        {showSpotEditor && (
          <div className="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center z-20 p-4">
            <SpotEditor
              spot={editingSpot}
              coordinates={clickCoordinates}
              onSave={handleSaveSpot}
              onCancel={() => {
                setShowSpotEditor(false);
                setEditingSpot(null);
                setClickCoordinates(null);
              }}
              onDelete={editingSpot ? () => handleDeleteSpot(editingSpot.id!) : undefined}
            />
          </div>
        )}
      </div>
    </div>
  );
}
